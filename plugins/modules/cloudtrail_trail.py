#!/usr/bin/python
# -*- coding: utf-8 -*-
# Copyright: (c) 2022, Ansible Project
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
# template: header.j2
# This module is autogenerated using the ansible.content_builder.
# See: https://github.com/ansible-community/ansible.content_builder


DOCUMENTATION = r"""
module: cloudtrail_trail
short_description: Creates and manages a trail that specifies the settings for delivery
    of log data to an Amazon S3 bucket.
description:
- Creates and manages a trail that specifies the settings for delivery of log data
    to an Amazon S3 bucket.
options:
    advanced_event_selectors:
        aliases:
        - AdvancedEventSelectors
        description:
        - Advanced event selectors let you create fine-grained selectors for the following
            AWS CloudTrail event record ?elds.
        - They help you control costs by logging only those events that are important
            to you.
        elements: dict
        suboptions:
            field_selectors:
                aliases:
                - FieldSelectors
                description:
                - A single selector statement in an advanced event selector.
                elements: dict
                suboptions:
                    ends_with:
                        aliases:
                        - EndsWith
                        description:
                        - An operator that includes events that match the last few
                            characters of the event record field specified as the
                            value of Field.
                        elements: str
                        type: list
                    equals:
                        aliases:
                        - Equals
                        description:
                        - An operator that includes events that match the exact value
                            of the event record field specified as the value of Field.
                        - This is the only valid operator that you can use with the
                            readOnly, eventCategory, and resources.type fields.
                        elements: str
                        type: list
                    field:
                        aliases:
                        - Field
                        description:
                        - A field in an event record on which to filter events to
                            be logged.
                        - Supported fields include readOnly, eventCategory, eventSource
                            (for management events), eventName, resources.type, and
                            resources.ARN.
                        type: str
                    not_ends_with:
                        aliases:
                        - NotEndsWith
                        description:
                        - An operator that excludes events that match the last few
                            characters of the event record field specified as the
                            value of Field.
                        elements: str
                        type: list
                    not_equals:
                        aliases:
                        - NotEquals
                        description:
                        - An operator that excludes events that match the exact value
                            of the event record field specified as the value of Field.
                        elements: str
                        type: list
                    not_starts_with:
                        aliases:
                        - NotStartsWith
                        description:
                        - An operator that excludes events that match the first few
                            characters of the event record field specified as the
                            value of Field.
                        elements: str
                        type: list
                    starts_with:
                        aliases:
                        - StartsWith
                        description:
                        - An operator that includes events that match the first few
                            characters of the event record field specified as the
                            value of Field.
                        elements: str
                        type: list
                type: list
            name:
                aliases:
                - Name
                description:
                - An optional, descriptive name for an advanced event selector, such
                    as Log data events for only two S3 buckets.
                type: str
        type: list
    cloud_watch_logs_log_group_arn:
        aliases:
        - CloudWatchLogsLogGroupArn
        description:
        - Specifies a log group name using an Amazon Resource Name (ARN), a unique
            identifier that represents the log group to which CloudTrail logs will
            be delivered.
        - Not required unless you specify CloudWatchLogsRoleArn.
        type: str
    cloud_watch_logs_role_arn:
        aliases:
        - CloudWatchLogsRoleArn
        description:
        - Specifies the role for the CloudWatch Logs endpoint to assume to write to
            a users log group.
        type: str
    enable_log_file_validation:
        aliases:
        - EnableLogFileValidation
        description:
        - Specifies whether log file validation is enabled.
        - The default is false.
        type: bool
    event_selectors:
        aliases:
        - EventSelectors
        description:
        - The type of email sending events to publish to the event destination.
        elements: dict
        suboptions:
            data_resources:
                aliases:
                - DataResources
                description:
                - CloudTrail supports data event logging for Amazon S3 objects and
                    AWS Lambda functions.
                - You can specify up to 250 resources for an individual event selector,
                    but the total number of data resources cannot exceed 250 across
                    all event selectors in a trail.
                - This limit does not apply if you configure resource logging for
                    all data events.
                elements: dict
                suboptions:
                    type:
                        aliases:
                        - Type
                        description:
                        - The resource type in which you want to log data events.
                        - You can specify AWS::S3::Object or AWS::Lambda::Function
                            resources.
                        type: str
                    values:
                        aliases:
                        - Values
                        description:
                        - An array of Amazon Resource Name (ARN) strings or partial
                            ARN strings for the specified objects.
                        elements: str
                        type: list
                type: list
            exclude_management_event_sources:
                aliases:
                - ExcludeManagementEventSources
                description:
                - An optional list of service event sources from which you do not
                    want management events to be logged on your trail.
                - In this release, the list can be empty (disables the filter), or
                    it can filter out AWS Key Management Service events by containing
                    kms.amazonaws.com.
                - By default, I(exclude_management_event_sources) is empty, and AWS
                    KMS events are included in events that are logged to your trail.
                elements: str
                type: list
            include_management_events:
                aliases:
                - IncludeManagementEvents
                description:
                - Specify if you want your event selector to include management events
                    for your trail.
                type: bool
            read_write_type:
                aliases:
                - ReadWriteType
                choices:
                - All
                - ReadOnly
                - WriteOnly
                description:
                - Specify if you want your trail to log read-only events, write-only
                    events, or all.
                - For example, the EC2 GetConsoleOutput is a read-only API operation
                    and RunInstances is a write-only API operation.
                type: str
        type: list
    force:
        default: false
        description:
        - Cancel IN_PROGRESS and PENDING resource requestes.
        - Because you can only perform a single operation on a given resource at a
            time, there might be cases where you need to cancel the current resource
            operation to make the resource available so that another operation may
            be performed on it.
        type: bool
    include_global_service_events:
        aliases:
        - IncludeGlobalServiceEvents
        description:
        - Specifies whether the trail is publishing events from global services such
            as IAM to the log files.
        type: bool
    insight_selectors:
        aliases:
        - InsightSelectors
        description:
        - A string that contains insight types that are logged on a trail.
        elements: dict
        suboptions:
            insight_type:
                aliases:
                - InsightType
                description:
                - The type of insight to log on a trail.
                type: str
        type: list
    is_logging:
        aliases:
        - IsLogging
        description:
        - Whether the CloudTrail is currently logging AWS API calls.
        type: bool
    is_multi_region_trail:
        aliases:
        - IsMultiRegionTrail
        description:
        - Specifies whether the trail applies only to the current region or to all
            regions.
        - The default is false.
        - If the trail exists only in the current region and this value is set to
            true, shadow trails (replications of the trail) will be created in the
            other regions.
        - If the trail exists in all regions and this value is set to false, the trail
            will remain in the region where it was created, and its shadow trails
            in other regions will be deleted.
        - As a best practice, consider using trails that log events in all regions.
        type: bool
    is_organization_trail:
        aliases:
        - IsOrganizationTrail
        description:
        - Specifies whether the trail is created for all accounts in an organization
            in AWS Organizations, or only for the current AWS account.
        - The default is false, and cannot be true unless the call is made on behalf
            of an AWS account that is the master account for an organization in AWS
            Organizations.
        type: bool
    kms_key_id:
        aliases:
        - KMSKeyId
        description:
        - Specifies the KMS key ID to use to encrypt the logs delivered by CloudTrail.
        - The value can be an alias name prefixed by alias/, a fully specified ARN
            to an alias, a fully specified ARN to a key, or a globally unique identifier.
        type: str
    purge_tags:
        default: true
        description:
        - Remove tags not listed in I(tags).
        type: bool
    s3_bucket_name:
        aliases:
        - S3BucketName
        description:
        - Specifies the name of the Amazon S3 bucket designated for publishing log
            files.
        - See Amazon S3 Bucket Naming Requirements.
        type: str
    s3_key_prefix:
        aliases:
        - S3KeyPrefix
        description:
        - Specifies the Amazon S3 key prefix that comes after the name of the bucket
            you have designated for log file delivery.
        - For more information, see Finding Your CloudTrail Log Files.
        - The maximum length is 200 characters.
        type: str
    sns_topic_name:
        aliases:
        - SnsTopicName
        description:
        - Specifies the name of the Amazon SNS topic defined for notification of log
            file delivery.
        - The maximum length is 256 characters.
        type: str
    state:
        choices:
        - present
        - absent
        - list
        - describe
        - get
        default: present
        description:
        - Goal state for resource.
        - I(state=present) creates the resource if it doesn't exist, or updates to
            the provided state if the resource already exists.
        - I(state=absent) ensures an existing instance is deleted.
        - I(state=list) get all the existing resources.
        - I(state=describe) or I(state=get) retrieves information on an existing resource.
        type: str
    tags:
        aliases:
        - Tags
        - resource_tags
        description:
        - A dict of tags to apply to the resource.
        - To remove all tags set I(tags={}) and I(purge_tags=true).
        type: dict
    trail_name:
        aliases:
        - TrailName
        description:
        - Not Provived.
        type: str
    wait:
        default: false
        description:
        - Wait for operation to complete before returning.
        type: bool
    wait_timeout:
        default: 320
        description:
        - How many seconds to wait for an operation to complete before timing out.
        type: int
author: Ansible Cloud Team (@ansible-collections)
version_added: 0.2.0
extends_documentation_fragment:
- amazon.aws.aws
- amazon.aws.ec2
- amazon.cloud.boto3
"""

EXAMPLES = r"""
"""

RETURN = r"""
result:
    description:
        - When I(state=list), it is a list containing dictionaries of resource information.
        - Otherwise, it is a dictionary of resource information.
        - When I(state=absent), it is an empty dictionary.
    returned: always
    type: complex
    contains:
        identifier:
            description: The unique identifier of the resource.
            type: str
        properties:
            description: The resource properties.
            type: dict
"""


from ansible_collections.amazon.cloud.plugins.module_utils.core import (
    AnsibleAmazonCloudModule,
)
from ansible_collections.amazon.cloud.plugins.module_utils.core import (
    CloudControlResource,
)
from ansible_collections.amazon.cloud.plugins.module_utils.core import (
    ansible_dict_to_boto3_tag_list,
)
from ansible_collections.amazon.cloud.plugins.module_utils.core import (
    scrub_none_parameters,
)
from ansible_collections.amazon.cloud.plugins.module_utils.core import map_key_to_alias


def main():
    argument_spec = dict(
        state=dict(
            type="str",
            choices=["present", "absent", "list", "describe", "get"],
            default="present",
        ),
    )

    argument_spec["cloud_watch_logs_log_group_arn"] = {
        "type": "str",
        "aliases": ["CloudWatchLogsLogGroupArn"],
    }
    argument_spec["cloud_watch_logs_role_arn"] = {
        "type": "str",
        "aliases": ["CloudWatchLogsRoleArn"],
    }
    argument_spec["enable_log_file_validation"] = {
        "type": "bool",
        "aliases": ["EnableLogFileValidation"],
    }
    argument_spec["advanced_event_selectors"] = {
        "type": "list",
        "elements": "dict",
        "options": {
            "name": {"type": "str", "aliases": ["Name"]},
            "field_selectors": {
                "type": "list",
                "elements": "dict",
                "options": {
                    "field": {"type": "str", "aliases": ["Field"]},
                    "equals": {
                        "type": "list",
                        "elements": "str",
                        "aliases": ["Equals"],
                    },
                    "starts_with": {
                        "type": "list",
                        "elements": "str",
                        "aliases": ["StartsWith"],
                    },
                    "ends_with": {
                        "type": "list",
                        "elements": "str",
                        "aliases": ["EndsWith"],
                    },
                    "not_equals": {
                        "type": "list",
                        "elements": "str",
                        "aliases": ["NotEquals"],
                    },
                    "not_starts_with": {
                        "type": "list",
                        "elements": "str",
                        "aliases": ["NotStartsWith"],
                    },
                    "not_ends_with": {
                        "type": "list",
                        "elements": "str",
                        "aliases": ["NotEndsWith"],
                    },
                },
                "aliases": ["FieldSelectors"],
            },
        },
        "aliases": ["AdvancedEventSelectors"],
    }
    argument_spec["event_selectors"] = {
        "type": "list",
        "elements": "dict",
        "options": {
            "data_resources": {
                "type": "list",
                "elements": "dict",
                "options": {
                    "type": {"type": "str", "aliases": ["Type"]},
                    "values": {
                        "type": "list",
                        "elements": "str",
                        "aliases": ["Values"],
                    },
                },
                "aliases": ["DataResources"],
            },
            "include_management_events": {
                "type": "bool",
                "aliases": ["IncludeManagementEvents"],
            },
            "read_write_type": {
                "type": "str",
                "choices": ["All", "ReadOnly", "WriteOnly"],
                "aliases": ["ReadWriteType"],
            },
            "exclude_management_event_sources": {
                "type": "list",
                "elements": "str",
                "aliases": ["ExcludeManagementEventSources"],
            },
        },
        "aliases": ["EventSelectors"],
    }
    argument_spec["include_global_service_events"] = {
        "type": "bool",
        "aliases": ["IncludeGlobalServiceEvents"],
    }
    argument_spec["is_logging"] = {"type": "bool", "aliases": ["IsLogging"]}
    argument_spec["is_multi_region_trail"] = {
        "type": "bool",
        "aliases": ["IsMultiRegionTrail"],
    }
    argument_spec["is_organization_trail"] = {
        "type": "bool",
        "aliases": ["IsOrganizationTrail"],
    }
    argument_spec["kms_key_id"] = {"type": "str", "aliases": ["KMSKeyId"]}
    argument_spec["s3_bucket_name"] = {"type": "str", "aliases": ["S3BucketName"]}
    argument_spec["s3_key_prefix"] = {"type": "str", "aliases": ["S3KeyPrefix"]}
    argument_spec["sns_topic_name"] = {"type": "str", "aliases": ["SnsTopicName"]}
    argument_spec["tags"] = {"type": "dict", "aliases": ["Tags", "resource_tags"]}
    argument_spec["trail_name"] = {"type": "str", "aliases": ["TrailName"]}
    argument_spec["insight_selectors"] = {
        "type": "list",
        "elements": "dict",
        "options": {"insight_type": {"type": "str", "aliases": ["InsightType"]}},
        "aliases": ["InsightSelectors"],
    }
    argument_spec["state"] = {
        "type": "str",
        "choices": ["present", "absent", "list", "describe", "get"],
        "default": "present",
    }
    argument_spec["wait"] = {"type": "bool", "default": False}
    argument_spec["wait_timeout"] = {"type": "int", "default": 320}
    argument_spec["force"] = {"type": "bool", "default": False}
    argument_spec["purge_tags"] = {"type": "bool", "default": True}

    required_if = [
        ["state", "present", ["is_logging", "s3_bucket_name", "trail_name"], True],
        ["state", "absent", ["trail_name"], True],
        ["state", "get", ["trail_name"], True],
    ]
    mutually_exclusive = []

    module = AnsibleAmazonCloudModule(
        argument_spec=argument_spec,
        required_if=required_if,
        mutually_exclusive=mutually_exclusive,
        supports_check_mode=True,
    )
    cloud = CloudControlResource(module)

    type_name = "AWS::CloudTrail::Trail"

    params = {}

    params["advanced_event_selectors"] = module.params.get("advanced_event_selectors")
    params["cloud_watch_logs_log_group_arn"] = module.params.get(
        "cloud_watch_logs_log_group_arn"
    )
    params["cloud_watch_logs_role_arn"] = module.params.get("cloud_watch_logs_role_arn")
    params["enable_log_file_validation"] = module.params.get(
        "enable_log_file_validation"
    )
    params["event_selectors"] = module.params.get("event_selectors")
    params["include_global_service_events"] = module.params.get(
        "include_global_service_events"
    )
    params["insight_selectors"] = module.params.get("insight_selectors")
    params["is_logging"] = module.params.get("is_logging")
    params["is_multi_region_trail"] = module.params.get("is_multi_region_trail")
    params["is_organization_trail"] = module.params.get("is_organization_trail")
    params["kms_key_id"] = module.params.get("kms_key_id")
    params["s3_bucket_name"] = module.params.get("s3_bucket_name")
    params["s3_key_prefix"] = module.params.get("s3_key_prefix")
    params["sns_topic_name"] = module.params.get("sns_topic_name")
    params["tags"] = module.params.get("tags")
    params["trail_name"] = module.params.get("trail_name")

    # The DesiredState we pass to AWS must be a JSONArray of non-null values
    _params_to_set = scrub_none_parameters(params)

    # Only if resource is taggable
    if module.params.get("tags") is not None:
        _params_to_set["tags"] = ansible_dict_to_boto3_tag_list(module.params["tags"])

    # Use the alias from argument_spec as key and avoid snake_to_camel conversions
    params_to_set = map_key_to_alias(_params_to_set, argument_spec)

    # Ignore createOnlyProperties that can be set only during resource creation
    create_only_params = ["/properties/TrailName"]

    # Necessary to handle when module does not support all the states
    handlers = ["create", "read", "update", "delete", "list"]

    state = module.params.get("state")
    identifier = ["/properties/TrailName"]

    results = {"changed": False, "result": {}}

    if state == "list":
        if "list" not in handlers:
            module.exit_json(
                **results, msg=f"Resource type {type_name} cannot be listed."
            )
        results["result"] = cloud.list_resources(type_name, identifier)

    if state in ("describe", "get"):
        if "read" not in handlers:
            module.exit_json(
                **results, msg=f"Resource type {type_name} cannot be read."
            )
        results["result"] = cloud.get_resource(type_name, identifier)

    if state == "present":
        results = cloud.present(
            type_name, identifier, params_to_set, create_only_params
        )

    if state == "absent":
        results["changed"] |= cloud.absent(type_name, identifier)

    module.exit_json(**results)


if __name__ == "__main__":
    main()
